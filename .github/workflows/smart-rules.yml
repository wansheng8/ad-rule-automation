name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      - name: â° è®¾ç½®ä¸Šæµ·æ—¶åŒºå¹¶åŒæ­¥æ—¶é—´
        run: |
          echo "=== è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· ==="
          sudo timedatectl set-timezone Asia/Shanghai 2>/dev/null || sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
          echo "Asia/Shanghai" | sudo tee /etc/timezone > /dev/null
          
          echo "=== åŒæ­¥ç½‘ç»œæ—¶é—´ ==="
          if command -v ntpdate &> /dev/null || sudo apt-get update && sudo apt-get install -y ntpdate 2>/dev/null; then
            sudo timeout 10 ntpdate -s -u ntp.aliyun.com 2>/dev/null || true
          fi
          
          echo "=== æœ€ç»ˆæ—¶é—´éªŒè¯ ==="
          echo "ä¸Šæµ·æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "æ—¶é—´æˆ³: $(date +%s)"

      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…Pythonä¾èµ–
        run: pip install -r requirements.txt

      - name: æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          if [ -d "dist" ]; then
            find dist/ -type f -name "*.txt" -delete
            find dist/ -type f -name "*.json" -delete
          fi
          echo "æ¸…ç†å®Œæˆ âœ…"

      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: python scripts/smart_rule_processor.py

      - name: éªŒè¯ç”Ÿæˆç»“æžœ
        run: |
          echo "=== ç”Ÿæˆæ–‡ä»¶éªŒè¯ ==="
          if [ -f "dist/adblock_optimized.txt" ] && [ -f "dist/hosts_optimized.txt" ]; then
            echo "âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            echo "Adblockæ–‡ä»¶æ—¶é—´: $(head -3 dist/adblock_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1)"
            echo "Hostsæ–‡ä»¶æ—¶é—´: $(head -3 dist/hosts_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1)"
          else
            echo "âŒ æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ã€‚"
          else
            CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$CURRENT_TIME]"
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æŽ¨é€ï¼"
          fi

      - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸš€ è§„åˆ™æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œå®Œæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dist/adblock_optimized.txt" ] && [ -f "dist/hosts_optimized.txt" ]; then
            AD_COUNT=$(grep -c '^[^!]' "dist/adblock_optimized.txt" 2>/dev/null || echo "0")
            HOSTS_COUNT=$(grep -c '^0\.0\.0\.0' "dist/hosts_optimized.txt" 2>/dev/null || echo "0")
            
            AD_TIME=$(head -3 dist/adblock_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1)
            HOSTS_TIME=$(head -3 dist/hosts_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1)
            
            echo "**è§„åˆ™ç»Ÿè®¡**: " >> $GITHUB_STEP_SUMMARY
            echo "- Adblockè§„åˆ™: $AD_COUNT æ¡ (æ—¶é—´: $AD_TIME)" >> $GITHUB_STEP_SUMMARY
            echo "- HostsåŸŸå: $HOSTS_COUNT ä¸ª (æ—¶é—´: $HOSTS_TIME)" >> $GITHUB_STEP_SUMMARY
          fi
