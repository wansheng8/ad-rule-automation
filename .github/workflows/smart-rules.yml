name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆå¼ºåˆ¶å…¨æ–°çŽ¯å¢ƒï¼‰
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      # 2. è®¾ç½®PythonçŽ¯å¢ƒ
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install -r requirements.txt

      # 4. ðŸ—‘ï¸ æ ¸å¿ƒæ–°å¢žï¼šæ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶
      - name: æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          # æ£€æŸ¥distç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "dist" ]; then
            echo "æ¸…ç†distç›®å½•ä¸­çš„æ–‡ä»¶..."
            
            # åˆ é™¤ä¹‹å‰ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½†ä¿ç•™distç›®å½•
            find dist/ -type f -name "*.txt" -delete
            find dist/ -type f -name "*.json" -delete
            find dist/ -type f -name "*.log" -delete
            
            echo "å‰©ä½™æ–‡ä»¶:"
            ls -la dist/ 2>/dev/null || echo "distç›®å½•ä¸ºç©º"
            
            # å¦‚æžœdistç›®å½•å®Œå…¨ä¸ºç©ºï¼Œå¯ä»¥åˆ é™¤ç›®å½•ï¼ˆå¯é€‰ï¼‰
            if [ -z "$(ls -A dist/ 2>/dev/null)" ]; then
              echo "distç›®å½•ä¸ºç©ºï¼Œç§»é™¤..."
              rmdir dist/
            fi
          else
            echo "distç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†"
          fi
          
          # æ¸…ç†statsç›®å½•ä¸­çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆä½†ä¿ç•™ç›®å½•ç»“æž„ï¼‰
          if [ -d "stats" ]; then
            echo "æ¸…ç†statsç›®å½•ä¸­çš„ä¸´æ—¶æ–‡ä»¶..."
            find stats/ -type f -name "*.log" -delete
            find stats/ -type f -name "*.tmp" -delete
          fi
          
          echo "æ¸…ç†å®Œæˆ âœ…"

      # 5. è¿è¡Œæ ¸å¿ƒå¤„ç†è„šæœ¬
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: |
          echo "=== å¼€å§‹è¿è¡Œè„šæœ¬ ==="
          date
          python scripts/smart_rule_processor.py
          echo "=== è„šæœ¬è¿è¡Œå®Œæˆ ==="
          date

      # 6. éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      - name: éªŒè¯ç”Ÿæˆç»“æžœ
        run: |
          echo "=== éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          if [ -d "dist" ]; then
            echo "ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
            ls -la dist/
            echo ""
            
            if [ -f "dist/adblock_optimized.txt" ]; then
              echo "Adblockæ–‡ä»¶å‰3è¡Œ:"
              head -3 dist/adblock_optimized.txt
              echo ""
              echo "Adblockè§„åˆ™æ•°é‡: $(grep -c '^[^!]' dist/adblock_optimized.txt 2>/dev/null || echo '0')"
            else
              echo "âŒ Adblockæ–‡ä»¶æœªç”Ÿæˆ"
            fi
            
            if [ -f "dist/hosts_optimized.txt" ]; then
              echo ""
              echo "Hostsæ–‡ä»¶å‰3è¡Œ:"
              head -3 dist/hosts_optimized.txt
              echo ""
              echo "Hostsè§„åˆ™æ•°é‡: $(grep -c '^0\.0\.0\.0' dist/hosts_optimized.txt 2>/dev/null || echo '0')"
            else
              echo "âŒ Hostsæ–‡ä»¶æœªç”Ÿæˆ"
            fi
          else
            echo "âŒ distç›®å½•æœªç”Ÿæˆ"
          fi

      # 7. é…ç½®Gitå¹¶æäº¤æ›´æ”¹
      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          # è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¦æäº¤
          echo "=== æ£€æŸ¥å˜æ›´ ==="
          
          # é¦–å…ˆç¡®ä¿distç›®å½•å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "âŒ distç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
            exit 1
          fi
          
          # æ£€æŸ¥distç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
          if [ -z "$(ls -A dist/ 2>/dev/null)" ]; then
            echo "âŒ distç›®å½•ä¸ºç©ºï¼Œæ²¡æœ‰æ–‡ä»¶å¯æäº¤"
            exit 1
          fi
          
          # æ·»åŠ æ–‡ä»¶åˆ°Git
          git add dist/
          
          # æ£€æŸ¥çŠ¶æ€
          echo "=== GitçŠ¶æ€ ==="
          git status --porcelain
          
          # æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "å‡†å¤‡æäº¤ï¼Œæ—¶é—´: $CURRENT_TIME"
          
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
            echo "å¯èƒ½åŽŸå› ï¼š"
            echo "1. è„šæœ¬æœªç”Ÿæˆæ–°æ–‡ä»¶"
            echo "2. ç”Ÿæˆçš„æ–‡ä»¶ä¸Žä¹‹å‰å®Œå…¨ç›¸åŒ"
            echo "3. .gitignoreæŽ’é™¤äº†è¿™äº›æ–‡ä»¶"
            
            # è¾“å‡º.gitignoreå¯¹distç›®å½•çš„å½±å“
            echo ""
            echo "=== .gitignoreæ£€æŸ¥ ==="
            git check-ignore dist/* 2>/dev/null || echo "æ²¡æœ‰.gitignoreè§„åˆ™å½±å“distç›®å½•"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$CURRENT_TIME]"
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æŽ¨é€ï¼"
            
            # æ˜¾ç¤ºæäº¤ä¿¡æ¯
            echo "æäº¤å“ˆå¸Œ: $(git rev-parse --short HEAD)"
          fi

      # 8. ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
      - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸ“Š è§„åˆ™æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œå®Œæˆæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ¸…ç†æ­¥éª¤çŠ¶æ€
          echo "**æ¸…ç†çŠ¶æ€**: âœ… å·²æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ–‡ä»¶ç”ŸæˆçŠ¶æ€
          echo "**æ–‡ä»¶ç”ŸæˆçŠ¶æ€**: " >> $GITHUB_STEP_SUMMARY
          if [ -f "dist/adblock_optimized.txt" ] && [ -f "dist/hosts_optimized.txt" ]; then
            echo "âœ… ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶å‡å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # èŽ·å–æ–‡ä»¶ç»Ÿè®¡
            AD_COUNT=$(grep -c '^[^!]' "dist/adblock_optimized.txt" 2>/dev/null || echo "0")
            HOSTS_COUNT=$(grep -c '^0\.0\.0\.0' "dist/hosts_optimized.txt" 2>/dev/null || echo "0")
            
            # èŽ·å–æ–‡ä»¶ä¸­çš„æ—¶é—´æˆ³
            AD_TIME=$(head -3 dist/adblock_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo "æœªæ‰¾åˆ°")
            HOSTS_TIME=$(head -3 dist/hosts_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo "æœªæ‰¾åˆ°")
            
            echo "**è§„åˆ™ç»Ÿè®¡**: " >> $GITHUB_STEP_SUMMARY
            echo "- Adblockè§„åˆ™: $AD_COUNT æ¡ (æ—¶é—´: $AD_TIME)" >> $GITHUB_STEP_SUMMARY
            echo "- HostsåŸŸå: $HOSTS_COUNT ä¸ª (æ—¶é—´: $HOSTS_TIME)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ–‡ä»¶ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**å¯èƒ½åŽŸå› **: " >> $GITHUB_STEP_SUMMARY
            echo "1. è„šæœ¬æ‰§è¡Œå‡ºé”™" >> $GITHUB_STEP_SUMMARY
            echo "2. ç½‘ç»œé—®é¢˜å¯¼è‡´è§„åˆ™èŽ·å–å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "3. è„šæœ¬é€»è¾‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**è¾“å‡ºæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          find dist -name "*.txt" -type f 2>/dev/null | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            lines=$(wc -l < "$file" | tr -d ' ')
            echo "- \`$filename\` ($size, $lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
          done || echo "- æ— è¾“å‡ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä½¿ç”¨è¯´æ˜Ž**: " >> $GITHUB_STEP_SUMMARY
          echo "1. Adblockè§„åˆ™: å¯¼å…¥åˆ°uBlock Originã€AdGuardç­‰æµè§ˆå™¨æ‰©å±•" >> $GITHUB_STEP_SUMMARY
          echo "2. Hostsè§„åˆ™: å¤åˆ¶åˆ°ç³»ç»Ÿhostsæ–‡ä»¶ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰" >> $GITHUB_STEP_SUMMARY
