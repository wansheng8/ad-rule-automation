name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'

permissions:
  contents: write  # å…³é”®ï¼šèµ‹äºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install -r requirements.txt

      # 4. è¿è¡Œæ ¸å¿ƒå¤„ç†è„šæœ¬ (åœ¨è¿™é‡Œç”Ÿæˆdist/ä¸‹çš„æ–‡ä»¶)
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: python scripts/smart_rule_processor.py
        # è„šæœ¬æ‰§è¡Œåï¼Œæ–‡ä»¶å°±ç”Ÿæˆäº†è™šæ‹Ÿæœºçš„å½“å‰ç›®å½•ä¸‹çš„dist/é‡Œ

      # 5. æ£€æŸ¥dist/ç›®å½•æ˜¯å¦æœ‰æ–°æ–‡ä»¶ç”Ÿæˆ (è¯Šæ–­æ­¥éª¤)
      - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ£€æŸ¥distç›®å½• ==="
          ls -la dist/ 2>/dev/null || echo "distç›®å½•ä¸å­˜åœ¨"
          echo "=== æ–‡ä»¶è¡Œæ•°ç»Ÿè®¡ ==="
          find dist/ -name "*.txt" -exec wc -l {} \; 2>/dev/null || echo "æœªæ‰¾åˆ°txtæ–‡ä»¶"

      # 6. é…ç½®Gitå¹¶æäº¤æ‰€æœ‰æ›´æ”¹ (å…³é”®æ­¥éª¤)
      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          # è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…é¡»æ˜¯GitHub Actions botï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¦æäº¤ï¼ˆé‡ç‚¹æ·»åŠ dist/ç›®å½•ï¼‰
          git add dist/ stats/  # ç¡®ä¿æ·»åŠ äº†distå’Œstatsç›®å½•
          
          # æ£€æŸ¥çŠ¶æ€ï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "=== GitçŠ¶æ€ ==="
          git status --porcelain

          # æäº¤æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æ¨é€ï¼"
          fi
