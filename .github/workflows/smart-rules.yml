name: å¹¿å‘Šè§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # UTC 2ç‚¹ (åŒ—äº¬æ—¶é—´10ç‚¹)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 35
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ç¼“å­˜æ¢å¤
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .cache/
          key: ${{ runner.os }}-rules-${{ hashFiles('requirements.txt', 'config/rule_sources.txt') }}
          restore-keys: |
            ${{ runner.os }}-rules-
            
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install requests
          
      - name: è¿è¡Œè§„åˆ™å¤„ç†
        timeout-minutes: 25
        run: |
          echo "========================================"
          echo "ğŸš€ å¼€å§‹å¤„ç†å¹¿å‘Šè§„åˆ™"
          echo "========================================"
          python scripts/smart_rule_processor.py
          
      - name: éªŒè¯ç”Ÿæˆæ–‡ä»¶
        run: |
          echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶æ£€æŸ¥:"
          if [ -d "dist" ]; then
            for file in dist/*.txt; do
              if [ -f "$file" ]; then
                echo "ğŸ“Š $(basename $file):"
                echo "  å¤§å°: $(wc -c < $file | numfmt --to=iec)"
                echo "  è¡Œæ•°: $(wc -l < $file | numfmt --grouping)"
              fi
            done
          else
            echo "âŒ distç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: æäº¤å’Œæ¨é€
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é…ç½®Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥å˜æ›´
          if git diff --quiet && git diff --staged --quiet; then
            echo "âœ… æ— å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ–‡ä»¶
          git add dist/ stats/
          
          # æäº¤
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ [$(date '+%Y-%m-%d %H:%M')]"
          
          # æ¨é€
          echo "ğŸš€ æ¨é€å˜æ›´åˆ°GitHub..."
          if git push origin HEAD:main; then
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi
