name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™è‡ªåŠ¨æ›´æ–°
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'config/**'
      - 'scripts/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ·»åŠ å†™å…¥æƒé™
      
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆé…ç½®ä»¤ç‰Œï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          # å¦‚æœæ˜¯forkçš„ä»“åº“ï¼Œæ·»åŠ ä¸‹é¢è¿™è¡Œ
          # persist-credentials: true
          
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: python scripts/smart_rule_processor.py
        
      - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          # æ£€æŸ¥distç›®å½•
          if [ -d "dist" ]; then
            echo "ğŸ“ distç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la dist/
            echo ""
            
            # æ£€æŸ¥ Adblock.txt
            if [ -f "dist/Adblock.txt" ]; then
              echo "âœ… Adblockæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
              echo "   æ–‡ä»¶å¤§å°: $(wc -c < dist/Adblock.txt | numfmt --to=iec)å­—èŠ‚"
              echo "   æ–‡ä»¶è¡Œæ•°: $(wc -l < dist/Adblock.txt)è¡Œ"
              echo "   æœ€åæ›´æ–°: $(head -5 dist/Adblock.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo 'æœªæ‰¾åˆ°')"
            else
              echo "âŒ Adblock.txt æ–‡ä»¶æœªç”Ÿæˆ"
            fi
            
            # æ£€æŸ¥ hosts.txt
            if [ -f "dist/hosts.txt" ]; then
              echo ""
              echo "âœ… Hostsæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
              echo "   æ–‡ä»¶å¤§å°: $(wc -c < dist/hosts.txt | numfmt --to=iec)å­—èŠ‚"
              echo "   æ–‡ä»¶è¡Œæ•°: $(wc -l < dist/hosts.txt)è¡Œ"
              echo "   0.0.0.0æ ¼å¼: $(grep -c '^0\.0\.0\.0' dist/hosts.txt 2>/dev/null || echo '0')ä¸ª"
              echo "   127.0.0.1æ ¼å¼: $(grep -c '^127\.0\.0\.1' dist/hosts.txt 2>/dev/null || echo '0')ä¸ª"
            else
              echo "âŒ hosts.txt æ–‡ä»¶æœªç”Ÿæˆ"
            fi
            
            # æ£€æŸ¥ Domains.txt
            if [ -f "dist/Domains.txt" ]; then
              echo ""
              echo "âœ… Domainsæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
              echo "   æ–‡ä»¶å¤§å°: $(wc -c < dist/Domains.txt | numfmt --to=iec)å­—èŠ‚"
              echo "   æ–‡ä»¶è¡Œæ•°: $(wc -l < dist/Domains.txt)è¡Œ"
              echo "   åŸŸåæ•°é‡: $(grep -c '^[^#]' dist/Domains.txt 2>/dev/null || echo '0')ä¸ª"
            else
              echo "âŒ Domains.txt æ–‡ä»¶æœªç”Ÿæˆ"
            fi
          else
            echo "âŒ distç›®å½•æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "=== æ£€æŸ¥statsç›®å½• ==="
          if [ -d "stats" ]; then
            echo "ğŸ“ statsç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la stats/
            echo ""
            
            STATS_COUNT=$(find stats/ -type f -name "*.json" -o -name "*.md" 2>/dev/null | wc -l)
            if [ "$STATS_COUNT" -gt 0 ]; then
              echo "âœ… statsç›®å½•æœ‰ $STATS_COUNT ä¸ªæŠ¥å‘Šæ–‡ä»¶"
              LATEST_STATS=$(find stats/ -type f -name "*.json" -printf "%T@ %p\n" 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
              if [ -n "$LATEST_STATS" ]; then
                echo "   æœ€æ–°æŠ¥å‘Š: $(basename "$LATEST_STATS")"
                echo "   æŠ¥å‘Šå¤§å°: $(wc -c < "$LATEST_STATS" | numfmt --to=iec)å­—èŠ‚"
              fi
            else
              echo "âš ï¸  statsç›®å½•ä¸ºç©ºï¼Œè„šæœ¬å¯èƒ½æœªç”ŸæˆæŠ¥å‘Š"
            fi
          else
            echo "â„¹ï¸  statsç›®å½•æœªç”Ÿæˆ"
          fi
          
      - name: é…ç½®Gitå¹¶æ¨é€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è®¾ç½®Gité…ç½®
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          echo "=== Gitå˜æ›´çŠ¶æ€ ==="
          git status --short
          
          echo "=== å…·ä½“å˜æ›´ ==="
          git diff --stat
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          echo "å‡†å¤‡æäº¤ï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "æäº¤å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          
          # å°è¯•æ¨é€ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
            if git push origin HEAD:main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              sleep 5
              
              # æ‹‰å–æœ€æ–°ä»£ç å¹¶é‡æ–°å°è¯•åˆå¹¶
              echo "æ‹‰å–æœ€æ–°ä»£ç ..."
              git pull --rebase origin main || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­å°è¯•æ¨é€..."
            fi
          done
