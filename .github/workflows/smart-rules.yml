name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  # å®šæ—¶æ‰§è¡Œ
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTC 2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - test
          - force
  
  # æŽ¨é€è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - 'config/**'
      - '.github/workflows/**'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        python-version: ['3.10']
    
    steps:
      - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ è®¾ç½®Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ§ª è¿è¡Œè§„åˆ™å¤„ç†
        id: process
        run: |
          echo "å¼€å§‹æ™ºèƒ½è§„åˆ™å¤„ç†..."
          
          # æ ¹æ®è¾“å…¥é€‰æ‹©æ¨¡å¼
          MODE="${{ github.event.inputs.mode || 'normal' }}"
          echo "è¿è¡Œæ¨¡å¼: $MODE"
          
          if [ "$MODE" = "test" ]; then
            python scripts/smart_rule_processor.py --test --verbose
          elif [ "$MODE" = "force" ]; then
            python scripts/smart_rule_processor.py --verbose
          else
            python scripts/smart_rule_processor.py
          fi
          
          # ç»Ÿè®¡ç»“æžœ
          if [ -d "dist" ]; then
            LATEST_ADBLOCK=$(ls -t dist/adblock_optimized_*.txt 2>/dev/null | head -1)
            LATEST_HOSTS=$(ls -t dist/hosts_optimized_*.txt 2>/dev/null | head -1)
            
            if [ -f "$LATEST_ADBLOCK" ]; then
              AD_COUNT=$(grep -c '^[^!]' "$LATEST_ADBLOCK" || echo "0")
              echo "adblock_count=$AD_COUNT" >> $GITHUB_OUTPUT
            fi
            
            if [ -f "$LATEST_HOSTS" ]; then
              HOSTS_COUNT=$(grep -c '^0\.0\.0\.0' "$LATEST_HOSTS" || echo "0")
              echo "hosts_count=$HOSTS_COUNT" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: ðŸ“Š æ£€æŸ¥å˜æ›´
        id: check-changes
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          
          # åˆ›å»ºå˜æ›´æ ‡è®°æ–‡ä»¶
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "æ£€æŸ¥æ—¶é—´: $TIMESTAMP" > changes.log
          
          # æ£€æŸ¥distç›®å½•å˜æ›´
          if [ -d "dist" ]; then
            echo "distç›®å½•æ–‡ä»¶:" >> changes.log
            ls -la dist/ >> changes.log
            
            # æ¯”è¾ƒæœ€æ–°æ–‡ä»¶
            git status dist/ >> changes.log 2>&1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if git diff --quiet; then
            echo "æ²¡æœ‰å‘çŽ°å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "å‘çŽ°æ–‡ä»¶å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºå˜æ›´æ–‡ä»¶
            echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨:" >> changes.log
            git status --porcelain >> changes.log
          fi
          
          # ä¸Šä¼ å˜æ›´æ—¥å¿—
          if [ -f "changes.log" ]; then
            echo "å˜æ›´æ—¥å¿—:" 
            cat changes.log
          fi
      
      - name: ðŸš€ æäº¤å˜æ›´
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "æäº¤å˜æ›´åˆ°GitHub..."
          
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # èŽ·å–æœ€æ–°æ–‡ä»¶ç»Ÿè®¡
          COMMIT_MESSAGE="ðŸ¤– æ™ºèƒ½è§„åˆ™æ›´æ–° [$(date +'%Y-%m-%d')]\n\n"
          
          if [ -d "dist" ]; then
            LATEST_ADBLOCK=$(ls -t dist/adblock_optimized_*.txt 2>/dev/null | head -1)
            LATEST_HOSTS=$(ls -t dist/hosts_optimized_*.txt 2>/dev/null | head -1)
            LATEST_STATS=$(ls -t stats/stats_*.json 2>/dev/null | head -1)
            
            if [ -f "$LATEST_ADBLOCK" ] && [ -f "$LATEST_HOSTS" ] && [ -f "$LATEST_STATS" ]; then
              # ä»Žç»Ÿè®¡æ–‡ä»¶è¯»å–æ•°æ®
              STATS_DATA=$(cat "$LATEST_STATS")
              AD_COUNT=$(echo "$STATS_DATA" | grep -o '"adblock": [0-9]*' | head -1 | grep -o '[0-9]*')
              HOSTS_COUNT=$(echo "$STATS_DATA" | grep -o '"hosts_domains": [0-9]*' | head -1 | grep -o '[0-9]*')
              
              COMMIT_MESSAGE+="ðŸ“Š æœ¬æ¬¡æ›´æ–°ç»Ÿè®¡:\n"
              COMMIT_MESSAGE+="- Adblockè§„åˆ™: $AD_COUNT æ¡\n"
              COMMIT_MESSAGE+="- HostsåŸŸå: $HOSTS_COUNT ä¸ª\n"
              COMMIT_MESSAGE+="- å¤„ç†æ—¶é—´: $(date +'%H:%M:%S')\n"
              COMMIT_MESSAGE+="\nðŸ“ ç”Ÿæˆæ–‡ä»¶:\n"
              
              for file in "$LATEST_ADBLOCK" "$LATEST_HOSTS" "$LATEST_STATS"; do
                FILENAME=$(basename "$file")
                SIZE=$(du -h "$file" | cut -f1)
                COMMIT_MESSAGE+="- \`$FILENAME\` ($SIZE)\n"
              done
            fi
          fi
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´å¹¶æäº¤
          git add .
          echo -e "$COMMIT_MESSAGE" | git commit -F -
          
          # æŽ¨é€åˆ°ä»“åº“
          git push
          
          echo "âœ… å˜æ›´å·²æäº¤"
      
      - name: ðŸ“ˆ ç”ŸæˆGitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          keep_files: false
          force_orphan: true
      
      - name: ðŸ“‹ ç”Ÿæˆå·¥ä½œæµæŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸš€ æ™ºèƒ½è§„åˆ™å¤„ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
            echo "**çŠ¶æ€**: âœ… è§„åˆ™å·²æ›´æ–°å¹¶æäº¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**è§„åˆ™ç»Ÿè®¡**: " >> $GITHUB_STEP_SUMMARY
            echo "- Adblockè§„åˆ™: ${{ steps.process.outputs.adblock_count || 'N/A' }} æ¡" >> $GITHUB_STEP_SUMMARY
            echo "- HostsåŸŸå: ${{ steps.process.outputs.hosts_count || 'N/A' }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€**: â„¹ï¸ è§„åˆ™æœªå‘ç”Ÿå˜åŒ–" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæœ€æ–°æ–‡ä»¶
          if [ -d "dist" ]; then
            echo "**æœ€æ–°ç”Ÿæˆçš„æ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
            ls -t dist/*.txt 2>/dev/null | head -5 | while read file; do
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              lines=$(wc -l < "$file" | tr -d ' ')
              echo "- \`$filename\` ($size, $lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ä½¿ç”¨è¯´æ˜Ž**: " >> $GITHUB_STEP_SUMMARY
          echo "1. Adblockè§„åˆ™: å¯¼å…¥åˆ°uBlock Originã€AdGuardç­‰æµè§ˆå™¨æ‰©å±•" >> $GITHUB_STEP_SUMMARY
          echo "2. Hostsè§„åˆ™: å¤åˆ¶åˆ°ç³»ç»Ÿhostsæ–‡ä»¶ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. è®¿é—® [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/) æŸ¥çœ‹æœ€æ–°è§„åˆ™" >> $GITHUB_STEP_SUMMARY