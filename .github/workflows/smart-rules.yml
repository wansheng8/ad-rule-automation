name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™è‡ªåŠ¨æ›´æ–°
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'config/**'
      - 'scripts/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-rules:
    runs-on: ubuntu-latest
    # ===ã€æ ¸å¿ƒä¼˜åŒ–ã€‘è®¾ç½®ä½œä¸šå…¨å±€è¶…æ—¶ ===
    timeout-minutes: 28
    
    permissions:
      contents: write
      
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆé…ç½®ä»¤ç‰Œï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ç¼“å­˜Pythonä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: ç¼“å­˜è§„åˆ™æ•°æ®
        uses: actions/cache@v3
        with:
          path: .cache/
          key: ${{ runner.os }}-rule-cache-${{ hashFiles('config/rule_sources.txt') }}
          restore-keys: |
            ${{ runner.os }}-rule-cache-
            
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        # ===ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ä¸ºæœ€è€—æ—¶çš„æ­¥éª¤å•ç‹¬è®¾ç½®è¶…æ—¶ ===
        timeout-minutes: 25
        run: python scripts/smart_rule_processor.py
        
      - name: è‡ªåŠ¨éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        timeout-minutes: 2
        run: |
          echo "=== è‡ªåŠ¨éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          if [ ! -d "dist" ]; then
            echo "âŒ distç›®å½•æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "ğŸ“ distç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la dist/
          echo ""
          
          for file in dist/*.txt; do
            if [ -f "$file" ]; then
              echo "ğŸ“Š $(basename $file):"
              echo "   å¤§å°: $(wc -c < $file | numfmt --to=iec)"
              echo "   è¡Œæ•°: $(wc -l < $file | numfmt --grouping)"
              echo ""
            fi
          done
          
      - name: è¿è¡Œç‹¬ç«‹è§„åˆ™è‡ªæŸ¥ï¼ˆå¯é€‰ï¼‰
        timeout-minutes: 5
        run: |
          if [ -f "scripts/rule_checker.py" ]; then
            echo "ğŸ” è¿è¡Œç‹¬ç«‹è§„åˆ™è‡ªæŸ¥..."
            python scripts/rule_checker.py
          else
            echo "âš ï¸  è§„åˆ™è‡ªæŸ¥è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          
      - name: æ£€æŸ¥è‡ªæŸ¥æŠ¥å‘Š
        timeout-minutes: 1
        run: |
          if [ -d "checks" ]; then
            echo "ğŸ“‹ è‡ªæŸ¥æŠ¥å‘Šæ–‡ä»¶:"
            ls -la checks/
            echo ""
            LATEST_CHECK=$(find checks/ -name "*.json" -type f | sort | tail -1)
            if [ -n "$LATEST_CHECK" ]; then
              echo "æœ€æ–°è‡ªæŸ¥æŠ¥å‘Š: $(basename $LATEST_CHECK)"
              echo "æŠ¥å‘Šå¤§å°: $(wc -c < $LATEST_CHECK | numfmt --to=iec)å­—èŠ‚"
            fi
          fi
          
      - name: é…ç½®Gitå¹¶æ¨é€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet && [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          git add .
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "æäº¤å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          
          echo "å°è¯•æ¨é€..."
          if git push origin HEAD:main; then
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi
