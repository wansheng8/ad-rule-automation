name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true

      - name: â° è®¾ç½®ä¸Šæµ·æ—¶åŒºå¹¶åŒæ­¥æ—¶é—´
        run: |
          echo "=== è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· ==="
          sudo timedatectl set-timezone Asia/Shanghai 2>/dev/null || sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
          echo "Asia/Shanghai" | sudo tee /etc/timezone > /dev/null
          
          echo "=== åŒæ­¥ç½‘ç»œæ—¶é—´ ==="
          if command -v ntpdate &> /dev/null || sudo apt-get update && sudo apt-get install -y ntpdate 2>/dev/null; then
            sudo timeout 10 ntpdate -s -u ntp.aliyun.com 2>/dev/null || true
          fi
          
          echo "=== æœ€ç»ˆæ—¶é—´éªŒè¯ ==="
          echo "ä¸Šæµ·æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "æ—¶é—´æˆ³: $(date +%s)"

      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…Pythonä¾èµ–
        run: pip install -r requirements.txt

      - name: æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== å¼€å§‹æ¸…ç†ä¹‹å‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          # æ¸…ç†distç›®å½•ä¸­çš„è§„åˆ™æ–‡ä»¶
          if [ -d "dist" ]; then
            echo "æ¸…ç†distç›®å½•ä¸­çš„æ–‡ä»¶..."
            find dist/ -type f -name "*.txt" -delete
            find dist/ -type f -name "*.json" -delete
            find dist/ -type f -name "*.log" -delete
            echo "âœ… distç›®å½•æ¸…ç†å®Œæˆ"
          else
            echo "â„¹ï¸  distç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          fi
          
          # æ¸…ç†statsç›®å½•ä¸­çš„æŠ¥å‘Šæ–‡ä»¶
          if [ -d "stats" ]; then
            echo "æ¸…ç†statsç›®å½•ä¸­çš„æŠ¥å‘Šæ–‡ä»¶..."
            find stats/ -type f -name "*.json" -delete
            find stats/ -type f -name "*.md" -delete
            find stats/ -type f -name "*.log" -delete
            find stats/ -type f -name "*.txt" -delete
            echo "âœ… statsç›®å½•æ¸…ç†å®Œæˆ"
          else
            echo "â„¹ï¸  statsç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          fi
          
          # æ£€æŸ¥æ¸…ç†ç»“æžœ
          echo ""
          echo "=== æ¸…ç†åŽç›®å½•çŠ¶æ€ ==="
          echo "distç›®å½•å†…å®¹:"
          ls -la dist/ 2>/dev/null || echo "  (ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
          echo ""
          echo "statsç›®å½•å†…å®¹:"
          ls -la stats/ 2>/dev/null || echo "  (ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
          
          echo ""
          echo "ðŸŽ¯ æ–‡ä»¶æ¸…ç†å®Œæˆï¼Œå‡†å¤‡å…¨æ–°ç”Ÿæˆ"

      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: |
          echo "=== å¼€å§‹è¿è¡Œè„šæœ¬ ==="
          date
          python scripts/smart_rule_processor.py
          echo "=== è„šæœ¬è¿è¡Œå®Œæˆ ==="
          date

      - name: éªŒè¯ç”Ÿæˆç»“æžœ
        run: |
          echo "=== éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          # æ£€æŸ¥distç›®å½•
          if [ -d "dist" ]; then
            echo "ðŸ“ distç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la dist/
            echo ""
            
            if [ -f "dist/adblock_optimized.txt" ]; then
              echo "âœ… Adblockæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
              echo "   æ–‡ä»¶å¤´æ—¶é—´: $(head -3 dist/adblock_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo 'æœªæ‰¾åˆ°')"
              echo "   è§„åˆ™æ•°é‡: $(grep -c '^[^!]' dist/adblock_optimized.txt 2>/dev/null || echo '0')"
            else
              echo "âŒ Adblockæ–‡ä»¶æœªç”Ÿæˆ"
            fi
            
            if [ -f "dist/hosts_optimized.txt" ]; then
              echo ""
              echo "âœ… Hostsæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
              echo "   æ–‡ä»¶å¤´æ—¶é—´: $(head -3 dist/hosts_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo 'æœªæ‰¾åˆ°')"
              echo "   åŸŸåæ•°é‡: $(grep -c '^0\.0\.0\.0' dist/hosts_optimized.txt 2>/dev/null || echo '0')"
            else
              echo "âŒ Hostsæ–‡ä»¶æœªç”Ÿæˆ"
            fi
          else
            echo "âŒ distç›®å½•æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "=== æ£€æŸ¥statsç›®å½• ==="
          if [ -d "stats" ]; then
            echo "ðŸ“ statsç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la stats/
            echo ""
            
            STATS_COUNT=$(find stats/ -type f -name "*.json" -o -name "*.md" 2>/dev/null | wc -l)
            if [ "$STATS_COUNT" -gt 0 ]; then
              echo "âœ… statsç›®å½•æœ‰ $STATS_COUNT ä¸ªæŠ¥å‘Šæ–‡ä»¶"
              # æ˜¾ç¤ºæœ€æ–°æŠ¥å‘Šçš„æ—¶é—´
              LATEST_STATS=$(find stats/ -type f -name "*.json" -printf "%T@ %p\n" 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
              if [ -n "$LATEST_STATS" ]; then
                echo "   æœ€æ–°æŠ¥å‘Š: $(basename "$LATEST_STATS")"
              fi
            else
              echo "âš ï¸  statsç›®å½•ä¸ºç©ºï¼Œè„šæœ¬å¯èƒ½æœªç”ŸæˆæŠ¥å‘Š"
            fi
          else
            echo "â„¹ï¸  statsç›®å½•æœªç”Ÿæˆ"
          fi

      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          echo "=== å‡†å¤‡æäº¤æ–‡ä»¶ ==="
          
          # ç¡®ä¿æœ‰æ–‡ä»¶å¯æäº¤
          if [ ! -d "dist" ] && [ ! -d "stats" ]; then
            echo "âŒ æ²¡æœ‰ç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # æ·»åŠ æ–‡ä»¶
          git add dist/ stats/ 2>/dev/null || true
          
          # æ£€æŸ¥çŠ¶æ€
          echo "=== Gitå˜æ›´çŠ¶æ€ ==="
          git status --porcelain
          
          # æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "å‡†å¤‡æäº¤ï¼Œæ—¶é—´: $CURRENT_TIME"
          
          if git diff --staged --quiet; then
            echo "âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
            echo "å¯èƒ½åŽŸå› ï¼š"
            echo "1. è„šæœ¬æœªç”Ÿæˆæ–°æ–‡ä»¶"
            echo "2. ç”Ÿæˆçš„æ–‡ä»¶ä¸Žä¹‹å‰å®Œå…¨ç›¸åŒ"
            echo "3. .gitignoreæŽ’é™¤äº†è¿™äº›æ–‡ä»¶"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$CURRENT_TIME]"
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æŽ¨é€ï¼"
          fi

      - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸš€ è§„åˆ™æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œå®Œæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ¸…ç†æ­¥éª¤çŠ¶æ€
          echo "**æ¸…ç†çŠ¶æ€**: âœ… å·²æ¸…ç† dist å’Œ stats ç›®å½•çš„æ—§æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ–‡ä»¶ç”ŸæˆçŠ¶æ€
          echo "**æ–‡ä»¶ç”ŸæˆçŠ¶æ€**: " >> $GITHUB_STEP_SUMMARY
          if [ -f "dist/adblock_optimized.txt" ] && [ -f "dist/hosts_optimized.txt" ]; then
            echo "âœ… ä¸¤ä¸ªæ ¸å¿ƒè§„åˆ™æ–‡ä»¶å‡å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # èŽ·å–æ–‡ä»¶ç»Ÿè®¡
            AD_COUNT=$(grep -c '^[^!]' "dist/adblock_optimized.txt" 2>/dev/null || echo "0")
            HOSTS_COUNT=$(grep -c '^0\.0\.0\.0' "dist/hosts_optimized.txt" 2>/dev/null || echo "0")
            
            # èŽ·å–æ–‡ä»¶ä¸­çš„æ—¶é—´æˆ³
            AD_TIME=$(head -3 dist/adblock_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo "æœªæ‰¾åˆ°")
            HOSTS_TIME=$(head -3 dist/hosts_optimized.txt | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1 || echo "æœªæ‰¾åˆ°")
            
            echo "**è§„åˆ™ç»Ÿè®¡**: " >> $GITHUB_STEP_SUMMARY
            echo "- Adblockè§„åˆ™: $AD_COUNT æ¡ (æ—¶é—´: $AD_TIME)" >> $GITHUB_STEP_SUMMARY
            echo "- HostsåŸŸå: $HOSTS_COUNT ä¸ª (æ—¶é—´: $HOSTS_TIME)" >> $GITHUB_STEP_SUMMARY
            
            # æ£€æŸ¥statsæŠ¥å‘Š
            STATS_FILES=$(find stats/ -type f -name "*.json" -o -name "*.md" 2>/dev/null | wc -l)
            if [ "$STATS_FILES" -gt 0 ]; then
              echo "- ç»Ÿè®¡æŠ¥å‘Š: $STATS_FILES ä¸ª" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ è§„åˆ™æ–‡ä»¶ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**å¯èƒ½åŽŸå› **: " >> $GITHUB_STEP_SUMMARY
            echo "1. è„šæœ¬æ‰§è¡Œå‡ºé”™" >> $GITHUB_STEP_SUMMARY
            echo "2. ç½‘ç»œé—®é¢˜å¯¼è‡´è§„åˆ™èŽ·å–å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "3. è„šæœ¬é€»è¾‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**è¾“å‡ºæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          
          # åˆ—å‡ºdistç›®å½•æ–‡ä»¶
          echo "**dist/ ç›®å½•**: " >> $GITHUB_STEP_SUMMARY
          find dist -name "*.txt" -type f 2>/dev/null | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            lines=$(wc -l < "$file" | tr -d ' ')
            echo "- \`$filename\` ($size, $lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
          done || echo "- æ— è§„åˆ™æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          
          # åˆ—å‡ºstatsç›®å½•æ–‡ä»¶
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**stats/ ç›®å½•**: " >> $GITHUB_STEP_SUMMARY
          find stats -type f \( -name "*.json" -o -name "*.md" \) 2>/dev/null | head -5 | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "- \`$filename\` ($size)" >> $GITHUB_STEP_SUMMARY
          done || echo "- æ— ç»Ÿè®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä½¿ç”¨è¯´æ˜Ž**: " >> $GITHUB_STEP_SUMMARY
          echo "1. Adblockè§„åˆ™: å¯¼å…¥åˆ°uBlock Originã€AdGuardç­‰æµè§ˆå™¨æ‰©å±•" >> $GITHUB_STEP_SUMMARY
          echo "2. Hostsè§„åˆ™: å¤åˆ¶åˆ°ç³»ç»Ÿhostsæ–‡ä»¶ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. ç»Ÿè®¡æŠ¥å‘Š: æŸ¥çœ‹ stats/ ç›®å½•äº†è§£å¤„ç†è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
