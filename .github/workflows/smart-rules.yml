name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç ï¼ˆå…³é”®ä¿®æ”¹ï¼šæ·»åŠ  clean: trueï¼‰
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true    # å…³é”®ï¼šæ¯æ¬¡è¿è¡Œå‰å®Œå…¨æ¸…ç†å·¥ä½œåŒºï¼Œé¿å…ç¼“å­˜é—®é¢˜

      # 2. è®¾ç½®PythonçŽ¯å¢ƒ
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install -r requirements.txt

      # 4. è¿è¡Œæ ¸å¿ƒå¤„ç†è„šæœ¬
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: python scripts/smart_rule_processor.py

      # 5. éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶å’Œæ—¶é—´æˆ³ï¼ˆè°ƒè¯•æ­¥éª¤ï¼‰
      - name: éªŒè¯ç”Ÿæˆç»“æžœ
        run: |
          echo "=== å½“å‰ç³»ç»Ÿæ—¶é—´ ==="
          date
          echo ""
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la dist/
          echo ""
          echo "=== Adblockæ–‡ä»¶å‰5è¡Œ ==="
          head -5 dist/adblock_optimized.txt 2>/dev/null || echo "Adblockæ–‡ä»¶ä¸å­˜åœ¨"
          echo ""
          echo "=== Hostsæ–‡ä»¶å‰5è¡Œ ==="
          head -5 dist/hosts_optimized.txt 2>/dev/null || echo "Hostsæ–‡ä»¶ä¸å­˜åœ¨"

      # 6. é…ç½®Gitå¹¶æäº¤æ›´æ”¹
      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          # è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¦æäº¤
          git add dist/
          
          # æ£€æŸ¥çŠ¶æ€
          echo "=== GitçŠ¶æ€ ==="
          git status --porcelain

          # æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æŽ¨é€ï¼"
          fi

      # 7. ç”Ÿæˆå·¥ä½œæµæŠ¥å‘Š
      - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### ðŸš€ è§„åˆ™å¤„ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¿è¡Œå®Œæˆæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dist/adblock_optimized.txt" ]; then
            AD_COUNT=$(grep -c '^[^!]' "dist/adblock_optimized.txt" || echo "0")
            echo "**Adblockè§„åˆ™**: $AD_COUNT æ¡" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "dist/hosts_optimized.txt" ]; then
            HOSTS_COUNT=$(grep -c '^0\.0\.0\.0' "dist/hosts_optimized.txt" || echo "0")
            echo "**HostsåŸŸå**: $HOSTS_COUNT ä¸ª" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**è¾“å‡ºæ–‡ä»¶**: " >> $GITHUB_STEP_SUMMARY
          find dist -name "*.txt" -type f | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            lines=$(wc -l < "$file" | tr -d ' ')
            echo "- \`$filename\` ($size, $lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
          done
