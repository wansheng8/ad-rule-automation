name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™è‡ªåŠ¨æ›´æ–°
on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'config/**'
      - 'scripts/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆé…ç½®ä»¤ç‰Œï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬
        run: python scripts/smart_rule_processor.py
        
      - name: è‡ªåŠ¨éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== è‡ªåŠ¨éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶ ==="
          
          # æ£€æŸ¥distç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "dist" ]; then
            echo "âŒ distç›®å½•æœªç”Ÿæˆ"
            exit 1
          fi
          
          echo "ğŸ“ distç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la dist/
          echo ""
          
          # æŸ¥æ‰¾æ‰€æœ‰.txtæ–‡ä»¶
          TXT_FILES=$(find dist/ -name "*.txt" -type f)
          
          if [ -z "$TXT_FILES" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•.txtæ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ“Š å‘ç° $(echo "$TXT_FILES" | wc -l) ä¸ª.txtæ–‡ä»¶"
          echo ""
          
          # åˆ†ææ¯ä¸ªæ–‡ä»¶
          for FILE in $TXT_FILES; do
            FILENAME=$(basename "$FILE")
            echo "ğŸ” åˆ†æ: $FILENAME"
            
            # è·å–æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
            FILE_SIZE=$(wc -c < "$FILE" | numfmt --to=iec)
            FILE_LINES=$(wc -l < "$FILE")
            
            # é‡‡æ ·åˆ†ææ–‡ä»¶å†…å®¹ç±»å‹
            SAMPLE=$(head -20 "$FILE")
            
            # è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹
            FILE_TYPE="æœªçŸ¥"
            if echo "$SAMPLE" | grep -q "Adblock-style\|uBlock Origin\|AdGuard"; then
              FILE_TYPE="Adblockè§„åˆ™"
              RULE_COUNT=$(grep -c '^[^!#]' "$FILE" 2>/dev/null || echo "0")
              echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
              echo "   ğŸ“ å¤§å°: $FILE_SIZE"
              echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
              echo "   ğŸ¯ è§„åˆ™æ•°: $RULE_COUNT"
              
            elif echo "$SAMPLE" | grep -q "^0\.0\.0\.0\|^127\.0\.0\.1\|/etc/hosts"; then
              FILE_TYPE="Hostsè§„åˆ™"
              IP_COUNT=$(grep -c '^0\.0\.0\.0' "$FILE" 2>/dev/null || echo "0")
              LOCAL_COUNT=$(grep -c '^127\.0\.0\.1' "$FILE" 2>/dev/null || echo "0")
              echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
              echo "   ğŸ“ å¤§å°: $FILE_SIZE"
              echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
              echo "   ğŸ”¢ 0.0.0.0: $IP_COUNT ä¸ª"
              echo "   ğŸ”¢ 127.0.0.1: $LOCAL_COUNT ä¸ª"
              
            elif echo "$SAMPLE" | grep -q "çº¯åŸŸå\|DNSè¿‡æ»¤\|åŸŸååˆ—è¡¨"; then
              FILE_TYPE="åŸŸååˆ—è¡¨"
              DOMAIN_COUNT=$(grep -c '^[^#]' "$FILE" 2>/dev/null || echo "0")
              echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
              echo "   ğŸ“ å¤§å°: $FILE_SIZE"
              echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
              echo "   ğŸŒ åŸŸåæ•°: $DOMAIN_COUNT"
              
            else
              # åŸºäºå†…å®¹ç‰¹å¾æ¨æ–­ç±»å‹
              if echo "$SAMPLE" | grep -q "^||.*\^\|##\|^/.*/$"; then
                FILE_TYPE="Adblockè§„åˆ™(æ¨æ–­)"
                RULE_COUNT=$(grep -c '^[^!#]' "$FILE" 2>/dev/null || echo "0")
                echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
                echo "   ğŸ“ å¤§å°: $FILE_SIZE"
                echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
                echo "   ğŸ¯ è§„åˆ™æ•°: $RULE_COUNT"
                
              elif echo "$SAMPLE" | grep -q "^[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+"; then
                FILE_TYPE="Hostsè§„åˆ™(æ¨æ–­)"
                IP_COUNT=$(grep -c '^[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+' "$FILE" 2>/dev/null || echo "0")
                echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
                echo "   ğŸ“ å¤§å°: $FILE_SIZE"
                echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
                echo "   ğŸ”¢ IPæ¡ç›®: $IP_COUNT ä¸ª"
                
              else
                # é»˜è®¤è®¤ä¸ºæ˜¯åŸŸååˆ—è¡¨
                FILE_TYPE="åŸŸååˆ—è¡¨(æ¨æ–­)"
                DOMAIN_COUNT=$(grep -c '^[a-zA-Z0-9]' "$FILE" 2>/dev/null || echo "0")
                echo "   ğŸ“Œ ç±»å‹: $FILE_TYPE"
                echo "   ğŸ“ å¤§å°: $FILE_SIZE"
                echo "   ğŸ“„ è¡Œæ•°: $FILE_LINES"
                echo "   ğŸŒ æœ‰æ•ˆè¡Œ: $DOMAIN_COUNT"
              fi
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤´ä¸­çš„æ›´æ–°æ—¶é—´
            UPDATE_TIME=$(head -5 "$FILE" | grep -oE '20[0-9]{2}-[0-9]{2}-[0-9]{2}' | head -1)
            if [ -n "$UPDATE_TIME" ]; then
              echo "   ğŸ• æœ€åæ›´æ–°: $UPDATE_TIME"
            fi
            
            echo ""
          done
          
          echo "=== æ£€æŸ¥statsç›®å½• ==="
          if [ -d "stats" ]; then
            echo "ğŸ“ statsç›®å½•æ–‡ä»¶åˆ—è¡¨:"
            ls -la stats/
            echo ""
            
            STATS_FILES=$(find stats/ -name "*.json" -o -name "*.md" 2>/dev/null | wc -l)
            if [ "$STATS_FILES" -gt 0 ]; then
              echo "âœ… statsç›®å½•æœ‰ $STATS_FILES ä¸ªæŠ¥å‘Šæ–‡ä»¶"
              LATEST_STATS=$(find stats/ -type f -name "*.json" -printf "%T@ %p\n" 2>/dev/null | sort -n | tail -1 | cut -d' ' -f2-)
              if [ -n "$LATEST_STATS" ]; then
                echo "   æœ€æ–°æŠ¥å‘Š: $(basename "$LATEST_STATS")"
                echo "   æŠ¥å‘Šå¤§å°: $(wc -c < "$LATEST_STATS" | numfmt --to=iec)å­—èŠ‚"
                
                # ä»JSONæŠ¥å‘Šä¸­æå–å…³é”®ä¿¡æ¯
                if command -v jq >/dev/null 2>&1; then
                  echo "   å…³é”®ç»Ÿè®¡:"
                  jq -r '.rules_summary | "     - Adblockè§„åˆ™: \(.adblock_rules)æ¡\n     - Hostsè§„åˆ™: \(.hosts_entries)ä¸ª\n     - åŸŸå: \(.domains)ä¸ª"' "$LATEST_STATS" 2>/dev/null || true
                fi
              fi
            else
              echo "âš ï¸  statsç›®å½•ä¸ºç©º"
            fi
          else
            echo "â„¹ï¸  statsç›®å½•æœªç”Ÿæˆ"
          fi
          
          echo ""
          echo "=== æ•´ä½“éªŒè¯ç»“æœ ==="
          echo "âœ… è‡ªåŠ¨åŒ–éªŒè¯å®Œæˆ"
          echo "   å‘ç°çš„è§„åˆ™æ–‡ä»¶: $(echo "$TXT_FILES" | wc -l) ä¸ª"
          echo "   æ€»æ–‡ä»¶å¤§å°: $(du -sh dist/ | cut -f1)"
          
      - name: é…ç½®Gitå¹¶æ¨é€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è®¾ç½®Gité…ç½®
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          echo "=== Gitå˜æ›´çŠ¶æ€ ==="
          git status --short
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          echo "å‡†å¤‡æäº¤ï¼Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$(date '+%Y-%m-%d %H:%M:%S')]" || echo "æäº¤å¯èƒ½å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ..."
          
          # æ¨é€å˜æ›´
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "å°è¯•æ¨é€ (ç¬¬ $((RETRY_COUNT + 1)) æ¬¡)..."
            if git push origin HEAD:main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
              echo "æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              sleep 5
              git pull --rebase origin main || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­å°è¯•æ¨é€..."
            fi
          done
