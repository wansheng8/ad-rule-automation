name: å¹¿å‘Šè§„åˆ™è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTC 2ç‚¹è¿è¡Œ
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 35    # æ€»è¶…æ—¶35åˆ†é’Ÿ
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: æ¢å¤ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .cache/
          key: ${{ runner.os }}-rules-${{ hashFiles('requirements.txt', 'config/rule_sources.txt') }}
          restore-keys: |
            ${{ runner.os }}-rules-
            
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install requests
          
      - name: è¿è¡Œä¼˜åŒ–è„šæœ¬ (æ ¸å¿ƒæ­¥éª¤)
        timeout-minutes: 30  # è„šæœ¬è¿è¡Œ30åˆ†é’Ÿè¶…æ—¶
        run: |
          echo "========================================"
          echo "ğŸš€ å¼€å§‹å¤„ç†å¹¿å‘Šè§„åˆ™"
          echo "========================================"
          python scripts/smart_rule_processor.py
          
      - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
          if [ -d "dist" ]; then
            ls -lh dist/
            echo ""
            for file in dist/*.txt; do
              if [ -f "$file" ]; then
                echo "ğŸ“Š $(basename $file):"
                echo "  å¤§å°: $(wc -c < $file | numfmt --to=iec)"
                echo "  è¡Œæ•°: $(wc -l < $file | numfmt --grouping)"
                echo ""
              fi
            done
          else
            echo "âŒ distç›®å½•ä¸å­˜åœ¨"
          fi
          
      - name: æäº¤å˜æ›´
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          git add dist/ stats/
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ [$(date '+%Y-%m-%d %H:%M')]" || true
          
          # å°è¯•æ¨é€
          for i in {1..3}; do
            echo "æ¨é€å°è¯• $i/3"
            if git push origin HEAD:main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            fi
            sleep 5
          done
