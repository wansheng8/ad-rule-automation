name: æ™ºèƒ½å¹¿å‘Šè§„åˆ™æ›´æ–°

on:
  workflow_dispatch:       # æˆ‘ä»¬å…ˆä¸“æ³¨æ‰‹åŠ¨è§¦å‘ï¼Œè°ƒè¯•æˆåŠŸåå¯ä»¥æ¢å¤å®šæ—¶è§¦å‘

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. å½»åº•æ¸…ç†å¹¶æ‹‰å–ä»£ç ï¼ˆå…³é”®ä¿®æ”¹ï¼šå¢åŠ æ¸…é™¤é…ç½®ï¼‰
      - name: æ£€å‡ºä»“åº“ä»£ç  (å¼ºåˆ¶å…¨æ–°ç¯å¢ƒ)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true
          # ä»¥ä¸‹é…ç½®ç¡®ä¿å½»åº•æ¸…ç†å¹¶è·å–æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
          ref: ${{ github.ref }}

      # 2. åœ¨è¿è¡Œå‰ï¼Œé¦–å…ˆéªŒè¯ä»“åº“ä¸­çš„è„šæœ¬å†…å®¹
      - name: éªŒè¯å½“å‰è„šæœ¬ç‰ˆæœ¬
        run: |
          echo "=== éªŒè¯ä»“åº“ä¸­è„šæœ¬çš„æœ€åä¿®æ”¹æ—¶é—´ ==="
          git log -1 --oneline -- scripts/smart_rule_processor.py
          echo ""
          echo "=== éªŒè¯è„šæœ¬ä¸­å…³é”®æ—¶é—´å‡½æ•° ==="
          grep -n "datetime.now()" scripts/smart_rule_processor.py || echo "æœªæ‰¾åˆ° datetime.now()"
          echo ""
          echo "=== ç³»ç»Ÿå½“å‰æ—¶é—´ (UTC) ==="
          date -u
          echo "=== ç³»ç»Ÿå½“å‰æ—¶é—´ (æœ¬åœ°) ==="
          date

      # 3. è®¾ç½®Pythonç¯å¢ƒ
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. å®‰è£…ä¾èµ–ï¼ˆæ¯æ¬¡å…¨æ–°å®‰è£…ï¼Œä¸ä½¿ç”¨ç¼“å­˜ï¼‰
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml --no-cache-dir

      # 5. è¿è¡Œè„šæœ¬å¹¶æ•è·è¯¦ç»†æ—¥å¿—
      - name: è¿è¡Œè§„åˆ™å¤„ç†è„šæœ¬ (è¯¦ç»†æ—¥å¿—)
        run: |
          echo "=== è¿è¡Œå‰ç³»ç»Ÿæ—¶é—´ ==="
          date
          echo ""
          echo "=== è¿è¡Œè„šæœ¬ï¼Œå¼€å¯è°ƒè¯•æ¨¡å¼ ==="
          python scripts/smart_rule_processor.py --verbose 2>&1 | tee /tmp/script_output.log
          echo ""
          echo "=== è„šæœ¬è¿è¡Œå®Œæˆï¼Œæ£€æŸ¥è¿”å›å€¼ ==="
          echo "è„šæœ¬é€€å‡ºä»£ç : $?"

      # 6. æ·±å…¥è¯Šæ–­ç”Ÿæˆçš„æ–‡ä»¶å’Œæ—¶é—´æˆ³
      - name: æ·±åº¦è¯Šæ–­ - éªŒè¯ç”Ÿæˆç»“æœ
        run: |
          echo "=== è¯Šæ–­æ—¶é—´ç‚¹ ==="
          date
          echo ""
          
          echo "=== æ£€æŸ¥ dist/ ç›®å½• ==="
          ls -la dist/ 2>/dev/null || echo "dist ç›®å½•ä¸å­˜åœ¨ï¼"
          echo ""
          
          if [ -f "dist/adblock_optimized.txt" ]; then
            echo "=== Adblock æ–‡ä»¶è¯¦æƒ… ==="
            echo "æ–‡ä»¶å¤§å°: $(wc -c < dist/adblock_optimized.txt) å­—èŠ‚"
            echo "è¡Œæ•°: $(wc -l < dist/adblock_optimized.txt)"
            echo ""
            echo "--- æ–‡ä»¶å‰10è¡Œ ---"
            head -10 dist/adblock_optimized.txt
            echo ""
            echo "--- æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ—¶é—´æˆ³ '2025-12-29'? ---"
            if grep -q "2025-12-29" dist/adblock_optimized.txt; then
              echo "âŒ å‘ç°æ—§æ—¶é—´æˆ³ '2025-12-29'"
              grep "2025-12-29" dist/adblock_optimized.txt
            else
              echo "âœ… æœªå‘ç°æ—§æ—¶é—´æˆ³"
              grep -E "202[0-9]-[0-9]{2}-[0-9]{2}" dist/adblock_optimized.txt || echo "æœªæ‰¾åˆ°æ—¶é—´æˆ³æ ¼å¼"
            fi
          else
            echo "âŒ Adblock æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "=== æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ—¶é—´æˆ³ ==="
          if [ -f "dist/adblock_optimized.txt" ]; then
            echo "æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´:"
            stat -c %y dist/adblock_optimized.txt 2>/dev/null || ls -la dist/adblock_optimized.txt
          fi

      # 7. æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨å½“å‰çœŸå®æ—¶é—´ï¼‰
      - name: æäº¤ç”Ÿæˆçš„è§„åˆ™æ–‡ä»¶
        run: |
          # å†æ¬¡ç¡®è®¤å½“å‰æ—¶é—´
          echo "=== æäº¤æ­¥éª¤å¼€å§‹æ—¶é—´ ==="
          date
          echo ""
          
          # è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
          echo "=== æ£€æŸ¥GitçŠ¶æ€ ==="
          git status --short
          echo ""
          
          # æ·»åŠ æ–‡ä»¶
          git add dist/
          
          # æäº¤ï¼ˆä½¿ç”¨å½“å‰ç³»ç»Ÿæ—¶é—´ï¼‰
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          echo "å‡†å¤‡æäº¤ï¼Œæäº¤ä¿¡æ¯æ—¶é—´: $CURRENT_TIME"
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè§„åˆ™ [$CURRENT_TIME]"
            
            # æ¨é€å‰å†æ¬¡éªŒè¯
            echo "=== æœ€åéªŒè¯æäº¤ä¿¡æ¯ ==="
            git log -1 --oneline
            
            git push
            echo "âœ… è§„åˆ™æ–‡ä»¶å·²æäº¤å¹¶æ¨é€ï¼"
          fi

      # 8. ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
      - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        if: always()
        run: |
          echo "### ğŸ•’ è§„åˆ™å¤„ç†æ—¶é—´è¯Šæ–­æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**å·¥ä½œæµæ‰§è¡Œæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æœ€ç»ˆæ–‡ä»¶çŠ¶æ€
          if [ -f "dist/adblock_optimized.txt" ]; then
            echo "**Adblockæ–‡ä»¶æ—¶é—´æˆ³æ£€æŸ¥**: " >> $GITHUB_STEP_SUMMARY
            FILE_TIME=$(head -3 dist/adblock_optimized.txt | grep -E "202[0-9]-[0-9]{2}-[0-9]{2}" || echo "æœªæ‰¾åˆ°æ—¶é—´æˆ³")
            echo "- æ–‡ä»¶å¤´ä¸­çš„æ—¶é—´: $FILE_TIME" >> $GITHUB_STEP_SUMMARY
            
            if echo "$FILE_TIME" | grep -q "2025-12-29"; then
              echo "  - âŒ **è­¦å‘Š**: æ–‡ä»¶åŒ…å«æ—§çš„æµ‹è¯•æ—¶é—´æˆ³ (2025-12-29)" >> $GITHUB_STEP_SUMMARY
              echo "  - å¯èƒ½åŸå› : è„šæœ¬æœªæ­£ç¡®æ›´æ–°æˆ–å­˜åœ¨ç¼“å­˜" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - âœ… æ—¶é—´æˆ³æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è¯Šæ–­å»ºè®®**: " >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥ 'éªŒè¯å½“å‰è„šæœ¬ç‰ˆæœ¬' æ­¥éª¤ï¼Œç¡®è®¤è„šæœ¬æœ€åä¿®æ”¹æ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "2. æ£€æŸ¥ 'æ·±åº¦è¯Šæ–­' æ­¥éª¤ä¸­æ–‡ä»¶æ˜¯å¦åŒ…å«æ—§æ—¶é—´æˆ³" >> $GITHUB_STEP_SUMMARY
          echo "3. å¦‚æœæ—¶é—´ä»ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è„šæœ¬ä¸­çš„ datetime.now() è°ƒç”¨" >> $GITHUB_STEP_SUMMARY
